"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),visible=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window;_classCallCheck(this,e),this.container=t,this.containerHeight=t.innerHeight,this.eleList=[],this.lastVisibleEle=null,this.cbs=[],this.__start()}return _createClass(e,[{key:"__start",value:function(){var e=this;this.container.addEventListener("scroll",function(){e.__detect()}),this.container.addEventListener("resize",function(){e.containerHeight=e.container.innerHeight,e.__detect()})}},{key:"__detect",value:function(){var e=this;if(!this.eleList.length&&this.lastVisibleEle){if(null===this.lastVisibleEle)return;return this.cbs.forEach(function(t){return t(e.lastVisibleEle,null)}),void(this.lastVisibleEle=null)}var t=this.eleList.filter(function(t){var i=t.getBoundingClientRect();return i.top<e.containerHeight&&e.containerHeight<i.bottom});if(0===t.length){if(null===this.lastVisibleEle)return;this.cbs.forEach(function(t){return t(e.lastVisibleEle,null)}),this.lastVisibleEle=null}else{if(this.lastVisibleEle===t[0])return;this.cbs.forEach(function(i){return i(e.lastVisibleEle,t[0])}),this.lastVisibleEle=t[0]}}},{key:"onChange",value:function(e){this.cbs.push(e)}},{key:"add",value:function(e){this.eleList.push(e),this.__detect()}},{key:"remove",value:function(e){this.eleList.splice(this.eleList.indexOf(e),1),this.__detect()}}]),e}();!function(){function e(e,t,i){var n=$("#r-useful_count-"+t),s=$("#r-useless_count-"+t);n.text(0===e.useful_count?"":e.useful_count),s.text(0===e.useless_count?"":e.useless_count),"useful"===i?(n.prev().attr("src",window.usefuled_icon),s.prev().attr("src",window.useless_icon)):(n.prev().attr("src",window.useful_icon),s.prev().attr("src",window.uselessed_icon))}function t(e,t){$("#review_"+e+"_short").addClass("hidden"),$("#review_"+e+"_full").removeClass("hidden").addClass("loaded"),t&&$("#review_"+e+"_full_content").html(t),$(".review-item#"+e+" .action .fold").removeClass("hidden"),l(document),r()}function i(e){$("#review_"+e+"_short").removeClass("hidden"),$("#review_"+e+"_full").addClass("hidden"),$("#"+e).get(0).scrollIntoViewIfNeeded(),$("#review_"+e+"_short").find(".unfold").text("展开"),$("#"+e).find(".action-placeholder").remove(),$("#"+e).find(".action").removeClass("fixed-action"),$("#"+e).find(".action .fold").addClass("hidden")}Element.prototype.scrollIntoViewIfNeeded||(Element.prototype.scrollIntoViewIfNeeded=function(e){e=0===arguments.length||!!e;var t=this.parentNode,i=window.getComputedStyle(t,null),n=parseInt(i.getPropertyValue("border-top-width")),s=parseInt(i.getPropertyValue("border-left-width")),o=this.offsetTop-t.offsetTop<t.scrollTop,r=this.offsetTop-t.offsetTop+this.clientHeight-n>t.scrollTop+t.clientHeight,l=this.offsetLeft-t.offsetLeft<t.scrollLeft,a=this.offsetLeft-t.offsetLeft+this.clientWidth-s>t.scrollLeft+t.clientWidth,c=o&&!r;(o||r)&&e&&(t.scrollTop=this.offsetTop-t.offsetTop-t.clientHeight/2-n+this.clientHeight/2),(l||a)&&e&&(t.scrollLeft=this.offsetLeft-t.offsetLeft-t.clientWidth/2-s+this.clientWidth/2),(o||r||l||a)&&!e&&this.scrollIntoView(c)});var n=new visible,s=window.is_released,o=window.txt_released||"";n.onChange(function(e,t){if(e&&($(e).find(".action").removeClass("fixed-action").css({width:"auto",left:"auto"}),$(e).find(".action-placeholder").remove()),t){$(t).append('<div class="action-placeholder" style="height: 46px;"></div>');var i=$(t).find(".action");i.addClass("fixed-action"),i.css({width:$(t).width()+"px",left:t.getBoundingClientRect().left+"px"})}});var r=function(){return"_IMAGE_GIF_RENDER"in window&&setTimeout(function(){return window._IMAGE_GIF_RENDER()},300)},l=function(){for(var e={useful_count:["有用","/j/review/{REVIEW_ID}/useful"],useless_count:["没用","/j/review/{REVIEW_ID}/useless"],spoiler:["剧透提醒已提交，谢谢","/j/review/{REVIEW_ID}/spoiler"]},t=/disabled/,i=/(\w+_count)/,n=/spoiler/,s=get_cookie("ck"),o=document.querySelectorAll(".main-panel-useful"),r=null,l="",a=function(e){return e&&"true"===e.getAttribute("data-is_owner")},c=function(e){return e&&"true"===e.getAttribute("data-can_vote")},u=function(e){return e&&"true"===e.getAttribute("data-is_tv")},d=function(o){if(!s)return void(window.location.href="https://accounts.douban.com/login");o.stopPropagation();var r=o.target,d=r.className,v=d.match(i)||d.match(n),w="",_="",g="";if(!d.match(t)){if(v){if(a(o.currentTarget))return alert("不能给自己投票噢");if(!c(o.currentTarget)){var p=u(o.currentTarget)?"该剧尚未播出，不能投票噢":"该电影还未上映，不能投票噢";return alert(p)}w=v[0],g=e[w][0],_=e[w][1],l=o.currentTarget.getAttribute("data-rid"),_=_.replace("{REVIEW_ID}",l)}else if(!v||!l)return;var b=$.post(_,{ck:s},function(e){if(0==e.r){if("spoiler"===w)return f();h(e,w)}});b.fail(function(){alert("网络错误")}).always(function(){})}},f=function(t){var i=document.getElementById(l),n=i.querySelector(".spoiler");n.innerText=e.spoiler[0],n.className=n.className.replace("not-reported","disabled")},h=function(i,n){var s=document.getElementById(l);for(var o in e)if(void 0!==i[o]){var r=e[o][0]+" "+i[o],a=s.querySelector("."+o),c=a.className;(o===n||o!==n&&c.match(t))&&a.classList.toggle("disabled"),a.innerHTML=r}},v=o.length,w=0;w<v;w++)r=o[w],r&&r.addEventListener("click",d,!1)};$("body").delegate(".review-item .action .up","click",function(){if(window._USER_ABNORMAL)return void(show_abnormal&&show_abnormal());var t=$(this).data("rid");return!s&&o?void alert(o):void $.post("/j/review/"+t+"/useful",{ck:get_cookie("ck")},function(i){e(i,t,"useful")})}),$("body").delegate(".review-item .action .down","click",function(){if(window._USER_ABNORMAL)return void(show_abnormal&&show_abnormal());var t=$(this).data("rid");return!s&&o?void alert(o):void $.post("/j/review/"+t+"/useless",{ck:get_cookie("ck")},function(i){e(i,t,"useless")})}),$("body").delegate(".review-short","click",function(){var e=this,i=$(this).data("rid");return $(this).data("loaded")?(t(i),void n.add($(this).closest(".review-item").get(0))):void($(this).data("loading")||($(this).data("loading",!0),$(this).find(".unfold").text("加载中..."),$.getJSON("/j/review/"+i+"/full",{},function(s){t(i,s.body),$(e).data("loading",!1).data("loaded",!0),n.add($(e).closest(".review-item").get(0)),$(e).closest(".review-item").find(".action-btn.up img").attr("src",s.votes.is_useful?window.usefuled_icon:window.useful_icon),$(e).closest(".review-item").find(".action-btn.down img").attr("src",s.votes.is_useless?window.uselessed_icon:window.useless_icon)})))}),$("body").delegate(".action .fold","click",function(){var e=$(this).closest(".review-item").find(".review-short").data("rid");i(e)}),$("body").delegate("a.report","click",function(){var e=$(this).siblings(".review-content").data("url");generate_report_dialog({report_url:e,type:["subject"]})})}();