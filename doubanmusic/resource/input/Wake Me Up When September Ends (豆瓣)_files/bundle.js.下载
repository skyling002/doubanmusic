!function(){"use strict";function f(e,n,t,o){var r,i,a=new Date;for(i in a.setTime(a.getTime()+24*(n||30)*60*60*1e3),r="; expires="+a.toGMTString(),t=t||(0<=location.hostname.indexOf("douban")?"douban.com":location.hostname),e)document.cookie=i+"="+e[i]+r+"; domain="+t+"; path="+(o||"/")}function v(e){for(var n,t=e+"=",o=document.cookie.split(";"),r=0;r<o.length;r++){for(n=o[r];" "==n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(t))return n.substring(t.length,n.length).replace(/\"/g,"")}return null}function a(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function o(e,n){function t(){o-=(new Date-r)/400,e.style.opacity=o<0?0:o,r=+new Date,0<o?window.requestAnimationFrame&&requestAnimationFrame(t)||setTimeout(t,16):n()}var o=1,r=(e.style.opacity=1,e.style.pointerEvents="none",+new Date);t()}function h(){window.console&&console.error.apply(console,arguments)}var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var t={exports:{}},r=(t.exports=i,t.exports.on=i);function i(e,n,t,o){return e.addEventListener||(n="on"+n),(e.addEventListener||e.attachEvent).call(e,n,t,o),t}t.exports.off=function(e,n,t,o){return e.removeEventListener||(n="on"+n),(e.removeEventListener||e.detachEvent).call(e,n,t,o),t};var l,t={exports:{}};l=t,function(){var a=function(e){return window.document.createElement(e)},r=window.encodeURIComponent,t=Math.random,e=function(e){var n,t,o,r,i;if((r={data:(e=null==e?{}:e).data||{},error:e.error||c,success:e.success||c,beforeSend:e.beforeSend||c,complete:e.complete||c,url:e.url||""}).computedUrl=u(r),0===r.url.length)throw new Error("MissingUrl");return(t=!1)!==r.beforeSend({},r)&&(o=e.callbackName||"callback",e=e.callbackFunc||"jsonp_"+s(15),n=r.data[o]=e,window[n]=function(e){return window[n]=null,r.success(e,r),r.complete(e,r)},(i=a("script")).src=u(r),i.async=!0,i.onerror=function(e){return r.error({url:i.src,event:e}),r.complete({url:i.src,event:e},r)},i.onload=i.onreadystatechange=function(){var e;if(!(t||"loaded"!==(e=this.readyState)&&"complete"!==e))return t=!0,i?((i.onload=i.onreadystatechange=null)!=(e=i.parentNode)&&e.removeChild(i),i=null):void 0},(o=window.document.getElementsByTagName("head")[0]||window.document.documentElement).insertBefore(i,o.firstChild)),{abort:function(){if(window[n]=function(){return window[n]=null},t=!0,null!=i&&i.parentNode)return i.onload=i.onreadystatechange=null,i.parentNode.removeChild(i),i=null}}},c=function(){},u=function(e){var n=e.url;return(n+=e.url.indexOf("?")<0?"?":"&")+o(e.data)},s=function(e){for(var n="";n.length<e;)n+=t().toString(36).slice(2,3);return n},o=function(n){var t,o;return function(){var e=[];for(t in n)o=n[t],e.push(r(t)+"="+r(o));return e}().join("&")};null!==l&&l.exports?l.exports=e:this.JSONP=e}.call(e);var c,u=n(t.exports),s=0,d=0;var m={a_delete_reply_notify:function(e){var t=e.target||e.srcElement,e=t.getAttribute("href").split("#")[1],e=_GLOBAL_NAV.DOUBAN_URL+"/j/reply_notify/remove_notify?id="+e;u({url:e,success:function(e){var n=t.closest(".item-req").parentNode;o(n,function(){n.parentNode.removeChild(n)})}})},a_discard_notify:function(e){var t=e.target||e.srcElement,e=t.getAttribute("name"),n=_GLOBAL_NAV.DOUBAN_URL+"/j/notification/discard";u({url:n,data:{id:e,ck:v("ck")},success:function(e){var n=t.closest(".item-req").parentNode;o(n,function(){n.parentNode.removeChild(n)})}})}};function p(e){s=e;var n,t=document.querySelector("#db-global-nav .top-nav-reminder");e?((n=t.querySelector(".num span"))?n.innerHTML=e:t.insertAdjacentHTML("beforeend",'<span class="num"><span>'+e+"</span><i></i></span>"),0<e&&e<10?t.style.marginRight="5px":10<=e&&(t.style.marginRight="15px")):(n=t.querySelector(".num"))&&n.parentNode.removeChild(n)}function _(e){d=e;var n=document.querySelector("#top-nav-doumail-link"),t=n.querySelector("em");e?(e="("+e+")",t?t.innerHTML=e:n.insertAdjacentHTML("beforeend","<em>"+e+"</em>")):t&&t.parentNode.removeChild(t)}var y=0,N=20,g=3e3;var L,w=null;function E(){clearTimeout(w),w=setTimeout(function e(){var n=parseInt(v("push_noty_num")||"0",10),t=parseInt(v("push_doumail_num")||"0",10);n!=s&&p(n),t!=d&&_(t),n||t?w=setTimeout(e,1500):clearTimeout(w)},1500)}function A(r,e,n){if(window.EventSource){var t="notification:user:"+r,n=r+"_"+n+":"+e,e="http://push.douban.com:4394/sse?channel="+t+"&auth="+n,o=("https:"==location.protocol&&(e="https://push.douban.com:4397/sse?channel="+t+"&auth="+n),null);try{o=new EventSource(e)}catch(e){return}o.addEventListener("open",function(){y=0},!1),o.addEventListener("error",function(e){this.readyState!=EventSource.CLOSED&&this.readyState!=EventSource.CONNECTING||(o.close(),o=null,setTimeout(function(){var n;(y+=1)<N&&(n=function(e,n){A(r,e,n)},u({url:_GLOBAL_NAV.DOUBAN_URL+"/j/push/get_token_with_ts",success:function(e){n(e.token,e.timestamp)}}))},y*g))},!1),o.addEventListener("message",function(e){var n,e=JSON.parse(e.data);"notification"==e.type?(p(e.num),c="Y",f({push_noty_num:e.num})):"doumail"==e.type&&(_(e.num),n=r,document.getElementById("top-nav-doumail-link").onclick=function(){try{moreurl(this,{from:"check_doumail_from_push",uid:n})}catch(e){}},f({push_doumail_num:e.num})),E();if(window.Notification&&e.num&&"1"==v("enable_push_desktop_noty")){var t="";if("notification"==e.type)t="你收到一个新提醒";else{if("doumail"!=e.type)return;t="你收到一封新豆邮"}var o=new Notification("豆瓣",{body:t,tag:e.id,icon:"//img3.doubanio.com/dae/accounts/resources/851ead1/shire/assets/dou36.png"});o.onclick=function(){window.focus(),this.close()},o.onshow=function(){setTimeout(function(){o.close()},3e3)}}},!1)}}function b(){var e=document.getElementById("top-nav-notimenu");e&&(r(e,"click",function(n){var e=(n.target||n.srcElement).closest(".j");if(e){a(n);for(var t=e.className.match(/a_(\w+)/gi),o=function(e){e=m[e];"function"==typeof e&&e.call(this,n)},r=void 0,i=0;i<t.length;i++)o.call(r,t[i])}}),r(window,"load",function(e){u({url:_GLOBAL_NAV.DOUBAN_URL+"/j/notification/num",success:function(e){p(e.num)}}),u({url:_GLOBAL_NAV.DOUBAN_URL+"/j/doumail/num",success:function(e){_(e.num)}}),A(_GLOBAL_NAV.USER_ID,_GLOBAL_NAV.SSE_TOKEN,_GLOBAL_NAV.SSE_TIMESTAMP),f({push_noty_num:_GLOBAL_NAV.N_NEW_NOTIS,push_doumail_num:_GLOBAL_NAV.N_NEW_DOUMAIL}),(_GLOBAL_NAV.N_NEW_NOTIS||_GLOBAL_NAV.N_NEW_DOUMAIL)&&E()}))}var O={version:null,key:function(){return("ap_"+O.version).replace(/\W/g,"_")+"_1"},cookie:"1",ifActive:function(t){function n(e,n){O.version=n,t.apply(null,arguments)}var e=(v("ap_v")||"").split(","),o="1"===e[0],r=e[1];if(2!==e.length){e={url:"https://m.douban.com/j/puppy/frodo_landing?include=anony_home",success:function(e){try{o=e.data.anony_home.shire_nav_tips,r=e.data.anony_home.version,f({ap_v:(o?"1":"0")+","+r},.0833)}catch(e){h(e)}o&&n(o,r)},failed:function(e){window.console&&console.error(e)}};function i(){}var a,c=e.method||"GET",u=e.url,s=e.body,l=e.success||i,d=e.failed||i,m=e.headers||{},p=new XMLHttpRequest;for(a in p.open(c,u),m)p.setRequestHeader(a,m[a]);p.onreadystatechange=function(){if(4===p.readyState&&200<=p.status&&p.status<300){var e=p.responseText;if("application/json"===m["Content-Type"]||"json"===p.responseType||e[0]+e[e.length-1]==="{}"){var n=e;try{n=JSON.parse(e)}catch(e){}l(n)}else l(p.responseText)}},p.onerror=function(e){h(e),d(new Error("Network error"))},p.send(s?JSON.stringify(s):null)}else n(o,r)},hide:function(){var e;if(O.version)return(e={})[O.key()]=O.cookie,f(e)}},S=document.querySelector("#doubanapp-tip");function k(){S&&(S.style.display="none")}function T(e){e=e.parentNode;k(),L=L&&(B(),e.contains(L))?null:(e.classList.add("more-active"),e.querySelector(".more-items"))}function B(){L&&L.parentNode.classList.remove("more-active")}function q(e){return new RegExp("(^| )"+e+"( |$)")}function D(e,n,t){for(var o=0;o<e.length;o++)n.call(t,e[o])}var x,U;function C(e){this.element=e}C.prototype={add:function(){D(arguments,function(e){this.contains(e)||(this.element.className+=" "+e)},this)},remove:function(){D(arguments,function(e){this.element.className=this.element.className.replace(q(e),"")},this)},toggle:function(e){return this.contains(e)?(this.remove(e),!1):(this.add(e),!0)},contains:function(e){return q(e).test(this.element.className)},replace:function(e,n){this.remove(e),this.add(n)}},"classList"in Element.prototype||Object.defineProperty(Element.prototype,"classList",{get:function(){return new C(this)}}),window.DOMTokenList&&null==DOMTokenList.prototype.replace&&(DOMTokenList.prototype.replace=C.prototype.replace),window.Element&&!Element.prototype.closest&&(Element.prototype.closest=function(e){var n,t=(this.document||this.ownerDocument).querySelectorAll(e),o=this;do{for(n=t.length;0<=--n&&t.item(n)!==o;);}while(n<0&&(o=o.parentElement));return o}),e=document.getElementById("db-global-nav"),S&&(O.ifActive(function(e,n){e&&(e=n,n=!!v(O.key()),S)&&!n&&(S.style.display="block",e)&&("textContent"in(n=S.querySelector(".version"))?n.textContent=e:n.innerText=e)}),r(S,"click",function(e){a(e),k(),0<=e.target.className.indexOf("tip-close")?O.hide():((e=document.createElement("a")).href="https://www.douban.com/doubanapp/app?channel=qipao",e.target="_blank",document.body.appendChild(e),e.click(),document.body.removeChild(e))})),r(e,"click",function(e){var o,n=(e.target||e.srcElement).closest(".bn-more, .top-nav-reminder .lnk-remind");n&&(a(e),T(n),n.classList.contains("lnk-remind"))&&(o=document.getElementById("top-nav-notimenu"),u({url:_GLOBAL_NAV.DOUBAN_URL+"/j/notification/nav_pop",data:{ck:v("ck"),k:_GLOBAL_NAV.UPLOAD_AUTH_TOKEN,from_push:c},success:function(e){var n,t;e.r||(o.innerHTML=e.s,0===(n=e.n)?(t=document.querySelector("#db-global-nav .top-nav-reminder .num"))&&t.parentNode.removeChild(t):(t=document.querySelector("#db-global-nav .top-nav-reminder .num span"))&&(t.innerHTML=n),f({push_noty_num:e.n}))}}))}),r(document,"click",function(e){(e.target||e.srcElement).closest(".more-items, .more-active")||L&&(B(),L=null)}),t=e.querySelector(".lnk-doubanapp"),e=e.querySelector("#top-nav-appintro"),t&&(r(t,"mouseenter",function(e){e=e.target||e.srcElement;e.parentNode.classList.contains("more-active")||T(e)}),r(t,"mouseleave",function(e){e.target||e.srcElement,x=setTimeout(function(){L&&(B(),L=null)},200)}),r(e,"mouseenter",function(e){x&&(clearTimeout(x),x=null)}),r(e,"mouseleave",function(e){e=e.target||e.srcElement;L&&(B(),e===L)&&(L=null)})),_GLOBAL_NAV.USER_ID&&b(),(U=document.querySelector(".nav-user-account .bn-more"))&&r(U,"click",function(){var e=U.parentNode,n=e.querySelector(".tips-common");n&&e.removeChild(n)})}();
